I"`K<p>This article logs a weekend of efforts to create a deep-learning environment which meets the following criteria</p>

<ul>
  <li>GPU Enabled</li>
  <li>On Arch Linux</li>
  <li>Uses <a href="https://keras.io/">Keras</a> with <a href="https://www.tensorflow.org/">Tensorflow</a> as a backend</li>
  <li>Main IDE being RStudio</li>
</ul>

<p>It was a tough one.</p>

<h2 id="update-2019-01-19">UPDATE: 2019-01-19</h2>
<p>It seems the Anaconda <code class="highlighter-rouge">conda</code> install tool now takes care of the gpu setup.</p>

<p>The following steps:</p>

<ul>
  <li>Install NVIDIA</li>
  <li>Downgrade CUDA to match CDNN</li>
</ul>

<p>Can now be replaced by installing <code class="highlighter-rouge">tensorflow-gpu</code> after installing Anaconda.</p>

<p>Run the following once <code class="highlighter-rouge">conda</code> is setup:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda <span class="nb">install</span> <span class="nt">-vv</span> tensorflow-gpu
</code></pre></div></div>

<h2 id="tldr">TL;DR</h2>
<p>There was error I had a hell of a time debugging.  Installing the toolchain is fairly straightforward, <em>except</em> CUDA.  At the time of writing this article (2018-04-29), there is a version mismatch between CUDA and CUDNN in the Arch Linux repositories.</p>

<p>This results in an the following error every time I tried to import tensorflow in Python.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ImportError: libcublas.so.9.0: cannot open shared object file: No such file or directory
</code></pre></div></div>
<p>The Arch Linux package CUDA was pulling the latest version 9.1.1 (at writing) and the Arch Linux package CUDNN was looking for version 9.0.  That little mismatch cost me 10 hours.</p>

<h3 id="0-other-arch-linux-deep-learning-articles">0. Other Arch Linux Deep-Learning Articles</h3>
<p>There are a couple other Arch Linux deep-learning setup walkthroughs.  Definitely need to give these guys credit, they are smarter than me.   However, neither walkthrough had everything I was looking for.</p>

<ul>
  <li><a href="https://medium.com/@k_efth/deep-learning-in-arch-linux-from-start-to-finish-with-pytorch-tensorflow-nvidia-cuda-9a873c2252ed">Deep Learning Setup in Arch Linux: From Start To Finish with PyTorch + TensorFlow + Nvidia CUDA + Anaconda</a></li>
</ul>

<p>This article was alright.  But it focused a lot on preparing Arch Linux from the bare metal, which is usually the right idea with Arch, <em>if</em> you are on a resource budget.  For example, running on a server or Raspberry Pi.  But the extra few bytes of RAM saved doesn’t really justify the time spent on meticulous tunning when we will be talking in megabytes and not bytes.  And let my immolation begin.</p>

<p>Also, this article doesn’t include information on GPU support.  <em>Whaawhaa.</em></p>

<ul>
  <li><a href="https://medium.com/@mimoralea/getting-started-with-nvidia-gpu-anaconda-tensorflow-and-keras-on-arch-linux-8f5f2868a455">Getting Started With NVIDIA GPU, Anaconda, TensorFlow and Keras on Arch Linux</a></li>
</ul>

<p>This one was a bit closer to what I need.  In fact, I did use the middle part.  However, the mismatch was not mentioned.  Of course, it’s not the author’s fault.   At the time he wrote it I’m guessing the repositories matched.</p>

<p>Alright, on to my attempt.</p>

<h3 id="1-install-antergos-arch-linux">1. Install Antergos (Arch Linux)</h3>
<p>I love me some Arch Linux.  It’s lightweight and avoids the long-term issues of other flavors.  Plus, it is meant to be headless, so it’s great for embedded projects.  Given how many embedded projects I take on it made me accustomed to using daily, eventually, I made it my main desktop flavor. It should sound too Linux-snobby, though, I dual-boot it on my Mac Book Pro.  The one issue with Arch Linux is it can be a little unfriendly to new users–or those with limited time and cannot be bothered with the nuances of setup. Enter Antergos.</p>

<p>Antergos is essentially Arch Linux with a desktop environment and a GUI installer.  A perfect choice for my deep-learning endeavors.  Really, you should check it out.  Go now.</p>

<ul>
  <li><a href="https://antergos.com/">Antergos</a></li>
</ul>

<p>We’re going to use it for this project.</p>

<p>Download the <code class="highlighter-rouge">iso</code> file</p>

<ul>
  <li><a href="https://antergos.com/download/antergos-live-iso/">Antergos (direct download)</a></li>
</ul>

<p>You’ll need a little jumpdrive, 4gb should work.</p>

<p>I use Etcher as it makes it painless to create boot media.</p>

<ul>
  <li><a href="https://etcher.io/">Etcher</a></li>
</ul>

<p>After Etcher does its thing, insert the jumpdrive, open Etcher, and then select the Antergos iso file.  <em>Here’s the usual warning, if you have anything on your jumpdrive it’s about to get deleted forever.</em></p>

<p><img src="../images/etcher_antergos.png" alt="" /></p>

<p>Insert the media into the machine you want to install Arch on and boot from the jumpdrive.</p>

<h4 id="windows">Windows</h4>
<p>You will need to hit a special key during the boot sequence to enter the BIOS’ boot menu</p>

<h4 id="mac">Mac</h4>
<p>While booting hold down the <code class="highlighter-rouge">Option</code> key.</p>

<p>If all goes well you should see a menu which says</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to GRUB!
</code></pre></div></div>
<p>And then shows an Antergos boot menu.  Select boot Antergos Live.</p>

<p>Once the boot sequence is finished you should see the Antergos desktop environment start and shortly after <code class="highlighter-rouge">cnchi</code>, which is Antergos’ GUI installer</p>

<p><img src="../images/cnchi.png" alt="" /></p>

<p>Select <code class="highlighter-rouge">Install It</code>.  The installer is fairly self explantory.  But, if you run in to any issues, please feel free to ask me questions in the comments.  I’m glad to help.</p>

<p>Once the installer is complete you will be prompted to restart the computer. It’s go time.</p>

<h3 id="2-install-nvidia">2. Install NVIDIA</h3>
<p>When you boot up the installed Antergos open the terminal.</p>

<p>We will start with installing the base NVIDIA packages.  As part of it, we are going to get the wrong version of CUDA.  But, I found downloading the NVIDIA as whole packages and then replacing CUDA with an earlier version, much eaiser than trying to pull everything together myself.</p>

<p>Ok, here we go.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S nvidia nvidia-utils cuda cudnn
</code></pre></div></div>
<p>That might take awhile.</p>

<p>…</p>

<p>So, how you been?  Oh–wait, it’s done.</p>

<p>Ok, to initialize the changes reboot.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo reboot now
</code></pre></div></div>

<h3 id="3-downgrade-cuda-to-match-cdnn">3. Downgrade CUDA to match CDNN</h3>
<p>That should have gotten everything at once.  Now, let’s downgrade CUDA from 9.1 to <em>9.0</em>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://archive.archlinux.org/packages/c/cuda/cuda-9.0.176-4-x86_64.pkg.tar.xz
</code></pre></div></div>
<p>This downloads a <code class="highlighter-rouge">pkg</code> file for CUDA 9.0, which is what the most recent version of Tensorflow is expecting (at this time, 1.8).  I found the easiest way to replace CUDA 9.1 with 9.0 to simply double click on the file we downloaded from the GUI file browser.  This opens it in Antergos’ answer to a GUI based package manager.  It will warn you this package will downgrade your CUDA version and ask you to <code class="highlighter-rouge">Commit</code> to the changes.  Hit the commit button.</p>

<p>Wait for the file to be replaced before moving on.</p>

<h3 id="4-anaconda">4. Anaconda</h3>
<p>Anaconda is a great package manager for data (mad) scientist tools.  It is Python centric, but also supports R and other stuff I don’t know how to use yet.</p>

<ul>
  <li><a href="https://www.anaconda.com/what-is-anaconda/">Anaconda</a></li>
</ul>

<p>We will be using it to prepare our system to support deep-learning projects.</p>

<ul>
  <li><a href="https://www.anaconda.com/what-is-anaconda/">Download Anaconda</a></li>
</ul>

<p>Download the Linux version suited for your computer.
<img src="../images/anaconda_download.png" alt="" /></p>

<p>Once the file is downloaded right click on the file and select <code class="highlighter-rouge">Show In Folder</code>.  Once there, right-click in the open space and select <code class="highlighter-rouge">Open in Terminal</code>.
<img src="../images/anaconda_download_box.png" alt="" /></p>

<p>Make Anaconda executable and then run it.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod +x Anaconda3-5.1.0-Linux-x86_64.sh
./Anaconda3-5.1.0-Linux-x86_64.sh
</code></pre></div></div>
<p>The Anaconda installtion is off and running.  It will ask you to agree to a form.  After, it will ask whether you want to install Anaconda in its default directory.  We do.</p>

<p>Now, it will install every data scientist package known to existance.  Mwhahaa. Erm.</p>

<p>When it asks</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Do you wish the installer to prepend the Anaconda3 install location
to PATH in your /home/ladvien/.bashrc ? [yes|no]
</code></pre></div></div>
<p>Type <code class="highlighter-rouge">yes</code>.  This will make Anaconda accessible throughout your system.</p>

<p>Of course, this new path variable will not be loaded until you start your user session again (log off and back on).  But we can force it to load by typing.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
source ./bash_profile
</code></pre></div></div>

<p>Double check we are using the Anaconda version of Python.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[ladvien@ladvien ~]$ which python
/home/ladvien/anaconda3/bin/python
</code></pre></div></div>
<p>If it doesn’t refer to <code class="highlighter-rouge">anaconda</code> somewhere in this path, then we need to fix that.  Let me know in the comments below and I’ll walk you through correcting it.</p>

<p>If it does, then let’s move forward!</p>

<h3 id="6-tensorflow-and-keras">6. Tensorflow and Keras</h3>
<p>Alright, almost done.</p>

<p>Let’s go back to the command prompt and type:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S python-pip
</code></pre></div></div>
<p>This will download Python’s module download manager <code class="highlighter-rouge">pip</code>.  This is usually packaged with Python, but isn’t included on Arch.</p>

<p>How’d we get Python?  Anaconda installed it.</p>

<p>Let’s download Tensorflow with GPU support.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pip install tensorflow-gpu --upgrade --ignore-installed
</code></pre></div></div>

<p>Let’s test and see if it’s worked. At command prompt type</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python
</code></pre></div></div>
<p>And in Python</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import tensorflow as tf
sess = tf.Session(config=tf.ConfigProto(log_device_placement=True))
</code></pre></div></div>
<p>You should a response similar to</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2018-05-01 05:25:25.929575: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1356] Found device 0 with properties:
name: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7715
pciBusID: 0000:01:00.0
totalMemory: 5.93GiB freeMemory: 5.66GiB
2018-05-01 05:25:25.929619: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1435] Adding visible gpu devices: 0
2018-05-01 05:25:26.333292: I tensorflow/core/common_runtime/gpu/gpu_device.cc:923] Device interconnect StreamExecutor with strength 1 edge matrix:
2018-05-01 05:25:26.333346: I tensorflow/core/common_runtime/gpu/gpu_device.cc:929]      0
2018-05-01 05:25:26.333356: I tensorflow/core/common_runtime/gpu/gpu_device.cc:942] 0:   N
2018-05-01 05:25:26.333580: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1053] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 5442 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)
Device mapping:
/job:localhost/replica:0/task:0/device:GPU:0 -&gt; device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1
2018-05-01 05:25:26.455082: I tensorflow/core/common_runtime/direct_session.cc:284] Device mapping:
/job:localhost/replica:0/task:0/device:GPU:0 -&gt; device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1
</code></pre></div></div>
<p>Which means you are good to go!  At this point, Python is setup to do accelerated deep-learning.  Most deep-learning peeps stop here, as Python is the deep-learning language.  However, like a pirate I’m an R sort of guy.</p>

<h3 id="7-installing-r-and-rstudio">7. Installing R and RStudio</h3>
<p>To setup a GPU accelerated deep-learning environment in R there isn’t a lot of additional setup.  There are <code class="highlighter-rouge">keras</code> and <code class="highlighter-rouge">tensorflow</code> R packages, which connect the R code to a Python backend.</p>

<p>To get R in Arch Linux open the terminal and type:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo pacman -S r
</code></pre></div></div>
<p>And what’s R without RStudio?  Actually, it’s still R, which is bad-ass unto itself–but anyway, let’s not argue.  Time to download RStudio…because you insist.</p>

<p>In terminal</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
git clone https://aur.archlinux.org/rstudio-desktop-bin.git
cd rstudio-desktop-bin
makepkg -i
</code></pre></div></div>
<p>After, you should find RStudio in the Antergos Menu.
<img src="../images/rstudio_antergos.png" alt="" /></p>

<p>You can right click on the icon and click <code class="highlighter-rouge">Add to Panel</code> to make a shortcut.</p>

<p>Open up RStudio and lets finish this up.</p>

<h3 id="8-r-packages-for-deep-learning">8. R Packages for Deep Learning</h3>
<p>Inside RStudio’s code console type</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install.packages("tensorflow")
</code></pre></div></div>
<p>This will install the package which will help the R environment find the Tensorflow Python modules.</p>

<p>Then,</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install.packages("keras")
</code></pre></div></div>
<p>Keras is the boss package, it’s going to connect all the Python modules needed to Tensorflow for us to focus on <em>just</em> the high-level deep-learning tuning.  It’s awesome.</p>

<p>Once the <code class="highlighter-rouge">keras</code> package is installed, we need to load it and connect it to the unerlying infrastructure we setup.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>library(keras)
install_keras(method = "conda", tensorflow = "gpu")
</code></pre></div></div>
<p>This will install the underlying Keras packages using the Anaconda ecosystem and Tensorflow Python modules using CUDA and CUDDN.  Note, a lot of this we setup manually, so it should report the needed modules are already there.  However, this step is still needed to awaken R to the fact those modules exist.</p>

<p>Alright, moment of truth.  Let’s run this code in R.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="n">tensorflow</span><span class="p">)</span><span class="w">

</span><span class="n">with</span><span class="p">(</span><span class="n">tf</span><span class="o">$</span><span class="n">device</span><span class="p">(</span><span class="s2">"/gpu:0"</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">const</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">constant</span><span class="p">(</span><span class="m">42</span><span class="p">)</span><span class="w">
</span><span class="p">})</span><span class="w">

</span><span class="n">sess</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tf</span><span class="o">$</span><span class="n">Session</span><span class="p">()</span><span class="w">
</span><span class="n">sess</span><span class="o">$</span><span class="n">run</span><span class="p">(</span><span class="n">const</span><span class="p">)</span></code></pre></figure>

<p>If all went well, it should provide you with a familiar output</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; library(tensorflow)
&gt;
&gt; with(tf$device("/gpu:0"), {
+   const &lt;- tf$constant(42)
+ })
/home/dl/.virtualenvs/r-tensorflow/lib/python3.6/site-packages/h5py/__init__.py:36: FutureWarning: Conversion of the second argument of issubdtype from `float` to `np.floating` is deprecated. In future, it will be treated as `np.float64 == np.dtype(float).type`.
  from ._conv import register_converters as _register_converters
&gt;
&gt; sess &lt;- tf$Session()
2018-05-01 05:55:07.412011: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1356] Found device 0 with properties:
name: GeForce GTX 1060 6GB major: 6 minor: 1 memoryClockRate(GHz): 1.7715
pciBusID: 0000:01:00.0
totalMemory: 5.93GiB freeMemory: 5.38GiB
2018-05-01 05:55:07.412057: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1435] Adding visible gpu devices: 0
2018-05-01 05:55:07.805042: I tensorflow/core/common_runtime/gpu/gpu_device.cc:923] Device interconnect StreamExecutor with strength 1 edge matrix:
2018-05-01 05:55:07.805090: I tensorflow/core/common_runtime/gpu/gpu_device.cc:929]      0
2018-05-01 05:55:07.805115: I tensorflow/core/common_runtime/gpu/gpu_device.cc:942] 0:   N
2018-05-01 05:55:07.805348: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1053] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 5150 MB memory) -&gt; physical GPU (device: 0, name: GeForce GTX 1060 6GB, pci bus id: 0000:01:00.0, compute capability: 6.1)
&gt; sess$run(const)
[1] 42
</code></pre></div></div>

<h3 id="9-scream-hello-world">9. Scream Hello World</h3>
<p>And the payoff?</p>

<p>Using the prepared Deep Dream script from the Keras documentation</p>

<ul>
  <li><a href="https://keras.rstudio.com/articles/examples/deep_dream.html">Keras Deep Dream in RStudio</a></li>
</ul>

<p><em>Voila!</em></p>
:ET