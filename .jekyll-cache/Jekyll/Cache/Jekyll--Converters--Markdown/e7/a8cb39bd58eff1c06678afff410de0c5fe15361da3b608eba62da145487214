I"ÊN<p>Continuing to explore R and SQL‚Äôs usefulness when it comes to HMIS data I decided to start posting HMIS problems and R and SQL solutions.</p>

<p>Problem: ¬†Our HMIS implementation has had three shelters entering data into one partition. ¬†This has been a lot like mixing three different colors of sand into one bucket‚Äìmuch easier to put in then sort out. ¬†It is also a problem since HUD requires Emergency Solution Grant (ESG) recipients to provide an annual standardized report, known as the CAPER, on data defined by the <a href="https://www.hudexchange.info/resources/documents/HMIS-Data-Dictionary.pdf">HMIS Data Dictionary</a>. These data elements are referred to as Universal Data Elements. ¬†With this mixed bucket data error responsibility becomes a big issue. ¬†The CAPER only allows up to 25% missing data, which makes data quality important. ¬†As for data repair, this should be completed by the agency which created the error. ¬†This makes communicating data issues imperative.</p>

<p>Unfortunately, when data from several agencies is mixed ,creating an error report is problematic‚Äîat least, for the HMIS software our continuum of care utilizes. ¬†The data quality reports our HMIS office produces lumps all errors together. ¬†This leads to¬†<a href="https://en.wikipedia.org/wiki/Social_loafing">social loafing</a>¬†between the agencies,¬†in turn,¬†few data repairs. ¬†</p>

<p>¬†Solution:¬† The solution seems to sort the data back out, re-assigning it to the respective agency‚Äôs data. ¬†This would allow data quality reports to assign responsibility of repair. ¬†Currently, our COC uses Social Solutions ETO software for manage our HMIS. ¬†The process of the moving the data consists of the following steps:</p>

<ol>
  <li>Determine all data which needs to be migrated. ¬†For us, this is Demographic, HUD Assessment, and Bed Stay data. ¬†</li>
  <li>Export these data sets.</li>
  <li>Sort the data sets to respective agencies.</li>
  <li>Import the data using a predefined template.</li>
</ol>

<p>This article focuses on the third step. ¬†The data has been exported, but how to sort it?</p>

<p>Below is a script written to take a flat file of HUD Assessments and¬†</p>

<ol>
  <li>Filter to to the respective program</li>
  <li>Filter HUD Assessments to¬†<em>just</em>¬†Protect Entry</li>
  <li>Repair the COC code (e.g., ‚Äútx601‚Äù -&gt; ‚ÄúTX-601‚Äù)</li>
  <li>Re-assign the data to the proper Site (agency‚Äôs data) and Program.</li>
  <li>Chop data into sets of no more than 500 rows, making the import process easier</li>
  <li>Write the data out to files.</li>
</ol>

<p>It‚Äôs pretty hackish, but it worked.</p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><span class="n">library</span><span class="p">(</span><span class="s2">"sqldf"</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"readxl"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Script Settings --------------------------------------------------------</span><span class="w">

</span><span class="c1"># Name of output file, not including CSV extension.</span><span class="w">
</span><span class="n">outputFileName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"HUD Assessments to Upload - v01 -"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Paths to input files.</span><span class="w">
</span><span class="n">inputFileNameforHUDAssessments</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"TCES HUD Assesment Batch Report of Active Participants on 12-31-2016 - v09.xlsx"</span><span class="p">)</span><span class="w">
</span><span class="n">inputFileNameforKeysToMatch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="s2">"PEIDs of TCES Active Participants.xlsx"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Names of target Site and Program</span><span class="w">
</span><span class="n">siteName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"The Salvation Army Mabee Center"</span><span class="w">
</span><span class="n">programName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"TSA Emergency Shelter Check In"</span><span class="w">

</span><span class="c1"># ----------------------------------------</span><span class="w">

</span><span class="c1"># Function to split files.</span><span class="w">
</span><span class="n">splitDataAndWriteFiles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="w"> </span><span class="n">chunkSize</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">success</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
  </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># If you want 20 samples, put any range of 20 values within the range of number of rows</span><span class="w">
    </span><span class="n">s</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(((</span><span class="n">count</span><span class="o">*</span><span class="n">chunkSize</span><span class="p">)</span><span class="m">+1</span><span class="p">),</span><span class="w"> </span><span class="s2">"  "</span><span class="p">,</span><span class="w"> </span><span class="p">((</span><span class="n">count</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">chunkSize</span><span class="p">))</span><span class="w">
    </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w">
    </span><span class="n">chunk</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">df</span><span class="p">[((</span><span class="n">count</span><span class="o">*</span><span class="n">chunkSize</span><span class="p">)</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span><span class="p">((</span><span class="n">count</span><span class="m">+1</span><span class="p">)</span><span class="o">*</span><span class="n">chunkSize</span><span class="p">),])</span><span class="w">
    </span><span class="c1">#chunk &lt;- sample(df[5:20,])</span><span class="w">
    </span><span class="c1">## this would contain first 20 rows</span><span class="w">
    </span><span class="n">fileName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste</span><span class="p">(</span><span class="n">outputFileName</span><span class="p">,</span><span class="w"> </span><span class="s2">"_"</span><span class="p">,</span><span class="w"> </span><span class="nf">as.character</span><span class="p">(</span><span class="n">count</span><span class="p">),</span><span class="w"> </span><span class="s2">".csv"</span><span class="p">)</span><span class="w">
    </span><span class="c1"># Write out all the Active HUD Assessments.</span><span class="w">
    </span><span class="n">write.csv</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileName</span><span class="p">,</span><span class="w"> </span><span class="n">na</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
    </span><span class="n">count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
    </span><span class="n">success</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">chunkSize</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  </span><span class="nf">return</span><span class="p">(</span><span class="n">success</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># Load all HUD Data</span><span class="w">
</span><span class="n">hudAssRaw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_excel</span><span class="p">(</span><span class="n">inputFileNameforHUDAssessments</span><span class="p">,</span><span class="w"> </span><span class="n">na</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="w">

</span><span class="n">hudAssRaw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">,</span><span class="w"> </span><span class="n">slect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="c1"># Re-title columns for easier handling.</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"peid"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)[</span><span class="m">11</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"Relation_to_HH"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)[</span><span class="m">12</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"COC_Code"</span><span class="w">

</span><span class="c1"># Replaces COC code for head's of household</span><span class="w">
</span><span class="n">hudAssRaw</span><span class="o">$</span><span class="n">COC_Code</span><span class="p">[</span><span class="n">with</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">,</span><span class="w"> </span><span class="n">Relation_to_HH</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Self (head of household)"</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"TX-601"</span><span class="w">

</span><span class="n">hudAssRaw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">,</span><span class="w"> </span><span class="n">slect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="c1"># Subset Project Entry data.</span><span class="w">
</span><span class="n">hudAssRaw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sqldf</span><span class="p">(</span><span class="s2">"SELECT * FROM hudAssRaw WHERE hudAssRaw.'At what point is this data being collected?_2270' = 'Project Entry'"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Replaces COC code for head's of household</span><span class="w">
</span><span class="n">hudAssRaw</span><span class="o">$</span><span class="s1">'Program Name'</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">programName</span><span class="w">
</span><span class="n">hudAssRaw</span><span class="o">$</span><span class="s1">'Site Name'</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">siteName</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)[</span><span class="m">13</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"A-3 What is the client's relationship t_2272"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)[</span><span class="m">14</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"A-5 HUD-assigned CoC code for the clien_2273"</span><span class="w">

</span><span class="c1"># Set the dates back to YYYY-MM-DD</span><span class="w">
</span><span class="c1">#hudAssRaw$`Response Date` &lt;- as.Date(hudAssRaw$`Response Date`, "%Y%m%d")</span><span class="w">
</span><span class="c1">#hudAssRaw$`DOB` &lt;- as.Date(hudAssRaw$`DOB`, "%Y%m%d")</span><span class="w">
</span><span class="c1">#hudAssRaw$`A-57 Approximate date homelessness star_6115` &lt;- as.Date(hudAssRaw$`A-57 Approximate date homelessness star_6115`, "%Y%m%d")</span><span class="w">
</span><span class="c1">#hudAssRaw$`A-58 Approximate date homelessness star_6116` &lt;- as.Date(hudAssRaw$`A-58 Approximate date homelessness star_6116`, "%Y%m%d")</span><span class="w">

</span><span class="n">hudAssRaw</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">,</span><span class="w"> </span><span class="n">slect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get target site Participant IDs</span><span class="w">
</span><span class="n">targetSiteParticipantIDs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_excel</span><span class="p">(</span><span class="s2">"TSA ESCI Target PSID.xlsx"</span><span class="p">)</span><span class="w">

</span><span class="n">assessmentsWithTargetPID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sqldf</span><span class="p">(</span><span class="s2">"SELECT * FROM targetSiteParticipantIDs
                                  INNER JOIN hudAssRaw   
                                  ON hudAssRaw.'Case Number'=targetSiteParticipantIDs.'Case Number'"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Free up space.</span><span class="w">
</span><span class="n">rm</span><span class="p">(</span><span class="n">hudAssRaw</span><span class="p">)</span><span class="w">
</span><span class="n">rm</span><span class="p">(</span><span class="n">targetSiteParticipantIDs</span><span class="p">)</span><span class="w">

</span><span class="n">assessmentsWithTargetPID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">assessmentsWithTargetPID</span><span class="p">,</span><span class="w"> </span><span class="n">slect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="n">colnames</span><span class="p">(</span><span class="n">assessmentsWithTargetPID</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"pid"</span><span class="w">
</span><span class="n">colnames</span><span class="p">(</span><span class="n">assessmentsWithTargetPID</span><span class="p">)[</span><span class="m">12</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s2">"rid"</span><span class="w">

</span><span class="c1"># INNER JOIN on self to get -only- the first HUD Assessment</span><span class="w">
</span><span class="c1"># Thanks SO! http://stackoverflow.com/questions/7745609/sql-select-only-rows-with-max-value-on-a-column</span><span class="w">
</span><span class="n">assessmentsWithTargetPID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sqldf</span><span class="p">(</span><span class="s2">"SELECT *
              FROM assessmentsWithTargetPID a
               INNER JOIN (
                  SELECT pid, MIN(rid) rid
                  FROM assessmentsWithTargetPID
                  GROUP BY pid
                ) b ON a.pid = b.pid AND a.rid = b.rid
              "</span><span class="p">)</span><span class="w">

</span><span class="c1"># Remove PEID</span><span class="w">
</span><span class="n">assessmentsWithTargetPID</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">assessmentsWithTargetPID</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">peid</span><span class="p">,</span><span class="n">peid.1</span><span class="p">))</span><span class="w">

</span><span class="n">write.csv</span><span class="p">(</span><span class="n">assessmentsWithTargetPID</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"First HUD Entry Assessments for ESCI.csv"</span><span class="p">,</span><span class="w"> </span><span class="n">na</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">

</span><span class="c1"># Split the data into chunks and write to files.</span><span class="w">
</span><span class="n">splitDataAndWriteFiles</span><span class="p">(</span><span class="n">activeEntryAssessments</span><span class="p">,</span><span class="w"> </span><span class="m">500</span><span class="p">)</span></code></pre></figure>
:ET