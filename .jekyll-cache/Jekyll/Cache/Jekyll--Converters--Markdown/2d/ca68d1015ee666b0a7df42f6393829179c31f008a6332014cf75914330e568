I"Ğ<p><a href="https://ladvien.com/lego_classifier/lego_classifier_comic.png"><img src="../images/lego_classifier/lego_classifier_comic.png" alt="" class="float-right" /></a> Iâ€™ve a robot friend.  To be clear, he is not a robot, rather, we build robots together.  One of the projects we tossed about is building a LEGO sorting machine.  Rockets is his name.  Anyway, Rocketsâ€“again, not a robotâ€“teaches robotics to kids.  For their designs, LEGOs are the primary component.  This results in a lot of time spent preparing for events.</p>

<p>He mentioned to me, â€œWhat we really need is a sorting machine.â€  I remained disinterested, but finally, I warmed up to the idea when he started talking about incorporating a deep neural-network.  More specifically, a convolutional neural-network (CNN).</p>

<p>Anyway, this blog series is the journal in building the LEGO sorter.</p>

<p>One last note to the reader: I wonâ€™t spend much time on explaining parts of the work where it is better documented elsehwere.  For example, Convolutional Neural Networks are well documented by, um, everyone?</p>

<p>Instead, Iâ€™m going to focus on stuff which Iâ€™ve found everyone else omitting.  Like, deploying the neural-network to do some work. This one bugged me, because everyone loves to say, â€œDude, my classifier has a validation accuracy of 99.999%!â€  Thatâ€™s great, but as I found out, validation accuracy doesnâ€™t always translate well into <em>production accuracy.</em></p>

<h2 id="the-idea">The Idea</h2>
<p>It was pretty straightfoward to begin with.  Weâ€™d find some images of LEGOs on the internet and then train a CNN to classify LEGOs by there part code.  It was a bit naive, but if knew the full amount of work a project like this would ahead of time I doubt anyone would do it.</p>

<p>Anyway, we began with searching the webs.  Google told us about several other folks doing something similiar.  Iâ€™m not going to list them all, only what I considered the best:</p>

<ul>
  <li><a href="https://medium.com/@pacogarcia3/tensorflow-on-raspbery-pi-lego-sorter-ab60019dcf32">Lego Sorter using TensorFlow on Raspberry Pi</a></li>
</ul>

<p>This is an <em>extremely</em> well documented project by <a href="https://medium.com/@pacogarcia3">Paco Garcia</a>.</p>

<p>So, after reading a few articles, we figured we could do this.  We just need the data.  After a bit of searching we found these existing datasets:</p>

<ul>
  <li><a href="https://www.kaggle.com/joosthazelzet/lego-brick-images">Kaggle: Database of Lego â€œImagesâ€ (they are rendered from models)</a></li>
  <li><a href="https://www.kaggle.com/pacogarciam3/lego-vs-generic-brick-image-recognition#example_Lego_1x4_crop0.jpg">Kaggle: Lego vs Generic Brick</a></li>
</ul>

<p>I wasnâ€™t happy about these datasets.  Their structures werenâ€™t great and they were not designed to help train a classifier.  But then, Rockets found Paco had actually opened his dataset to the public:</p>

<ul>
  <li><a href="https://www.kaggle.com/pacogarciam3/lego-brick-sorting-image-recognition?fbclid=IwAR303nIR4revbYVmW7YfC_4Frnqu3yn5gOi_HP7elJ4h1_a7uXDE1MVtacw">Kaggle: Lego Brick Sorting (best)</a></li>
</ul>

<p>One bit more, Paco also made his code public:</p>

<ul>
  <li><a href="https://github.com/pacogarcia3/lego-11class-tensorflow">11 Class Tensorflow Model</a></li>
</ul>

<p>Paco, you are a robot friend, too!</p>

<p>Alright, we were encouraged by Paco.  We knew the project would be possible.  However, we didnâ€™t want to step on <a href="https://en.wikipedia.org/wiki/Brownfield_(software_development)">brownfield</a>.  We needed the green. Or if you donâ€™t speak dev, we didnâ€™t want to do this the easy way and replicate Pacoâ€™s work.  We wanted to really beat ourselves up by doing everything from scratch.</p>

<h2 id="creating-a-dataset">Creating a Dataset</h2>
<p>As I stated before, I didnâ€™t like any datasets but Pacoâ€™s.  It was real images and meant to train a classifier.  But, they werenâ€™t the LEGOs we wanted to classify.  Rocketsâ€™s LEGO projects involve a lot of technic bricks, which didnâ€™t seem to be in Pacoâ€™s mix.  So, we set out to create our own.</p>

<p>The first attempt creating training images was by rendering images from <code class="highlighter-rouge">.stl</code> files found on the internet using the Python version of <a href="https://vtk.org/">Visualization Toolkit</a>.  I wonâ€™t cover it here since it was a fail and as Iâ€™ll create an article later about the stuff we tried and didnâ€™t work.</p>

<p><img src="../images/lego_classifier/rockets_contraption.jpg" alt="" class="float-left" /> Anyway, while I was working on it Rockets had a brilliant plan.  He created an instrument to take pictures of a LEGO on a spin plate.  It used a Raspberry Pi, Pi Cam, and stepper motor, and unicorn farts.</p>

<p>Then Rockets began taking pictures of 10 classes of LEGOs. Not sure how long this took , but shortly he pinged me saying he had 19,000 images. (Ok, ok, he might be <em>part</em> robot.)</p>

<p>Iâ€™m not going to attempt explaining the build, as I believe Rockets will do this later.  Besides, about the only part I understand is the unicorn flatulence.</p>

<p>Alright! Now I needed to get my butt in gear and fix up the software.</p>
<div style="clear: both;"></div>

<h2 id="preprocessing-code">Preprocessing Code</h2>
<p>Before we could start training a CNN on Rocketsâ€™s images we needed to do some preprocessing.  First, the images came in at full resolution, but we needed to crop them, as the CNN train better on square image.  Of course, the image would need to be cropped as not to lose the target data (the LEGO).</p>

<p>For example
<img src="../images/lego_classifier/crop_and_resize.png" alt="preprocess-image-for-cnn" /></p>

<p>Also, the trainer would be expecting a file structure something like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data
â”œâ”€â”€ <span class="nb">test</span>
â”‚Â Â  â”œâ”€â”€ 2456
â”‚   â”‚     â””â”€â”€ 2456_0001.jpg
â”‚   â”‚     â””â”€â”€ 2456_0002.jpg
â”‚   â”‚     â””â”€â”€ 2456_0003.jpg
â”‚   â”‚     â””â”€â”€ ....
â”‚Â Â  â”œâ”€â”€ 3001
â”‚Â Â  â”œâ”€â”€ 3002
â”‚Â Â  â”œâ”€â”€ 3003
â”‚Â Â  â”œâ”€â”€ 3004
â”‚Â Â  â”œâ”€â”€ 3010
â”‚Â Â  â”œâ”€â”€ 3039
â”‚Â Â  â”œâ”€â”€ 32064
â”‚Â Â  â”œâ”€â”€ 3660
â”‚Â Â  â””â”€â”€ 3701
â””â”€â”€ train
    â”œâ”€â”€ 2456
    â”œâ”€â”€ 3001
    â”œâ”€â”€ 3002
    â”œâ”€â”€ 3003
    â”œâ”€â”€ 3004
    â”œâ”€â”€ 3010
    â”œâ”€â”€ 3039
    â”œâ”€â”€ 32064
    â”œâ”€â”€ 3660
    â””â”€â”€ 3701
</code></pre></div></div>
<p>Therefore, Iâ€™ve written a Python script to do the following</p>

<ol>
  <li>Take a path where images are stored by name of the class</li>
  <li>Load the image</li>
  <li>Resize the image to specified size</li>
  <li>Crop from the center of the image out</li>
  <li>Create a train and test folder</li>
  <li>Create subfolders in train and test with the class name</li>
  <li>Shuffle the images in the process</li>
  <li>Save the cropped file in the appropriate folder, depending what percentage of images you want to withhold for testing.</li>
  <li>Repeat steps 2-8 for every image</li>
</ol>

<p>Letâ€™s jump into the code.</p>

<p>The full code can found here:</p>

<ul>
  <li><a href="https://github.com/Ladvien/lego_sorter/blob/master/square_crop.py">square_crop.py</a></li>
</ul>

<p>But Iâ€™ll walk through the code below.</p>

<h2 id="preprocessing-code-needed-libraries">Preprocessing Code: Needed Libraries</h2>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">random</span>
</code></pre></div></div>
<p>The only non-standard Python library we are using is:</p>

<ul>
  <li><a href="https://pypi.org/project/opencv-python/">OpenCV</a></li>
</ul>

<p>This may be a bit tricky depending on which OS you are using and whether you are using Anaconda or straight Python.  However, the following is what we used:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>https://pypi.org/project/opencv-python/
</code></pre></div></div>

<p>If you have any troubles load the <code class="highlighter-rouge">cv2</code> library, it probably means there was an issue installing OpenCV.  Just let me know in the comments and I can help debug.</p>

<h2 id="preprocessing-code-processing-parameters">Preprocessing Code: Processing Parameters</h2>
<p>The following control the the flow of preprocessing</p>

<ul>
  <li><code class="highlighter-rouge">dry_run</code>: if set to true, it does not save the images, but does everything else</li>
  <li><code class="highlighter-rouge">gray_scale</code>: converts the images to grayscale.</li>
  <li><code class="highlighter-rouge">root_path</code>: the root folder of the project</li>
  <li><code class="highlighter-rouge">show_image</code>: shows the before and after of the image.</li>
  <li><code class="highlighter-rouge">output_img_size</code>: adjust this to the size of your desired output image</li>
  <li><code class="highlighter-rouge">grab_area</code>: the total area of the original image to take before resizing</li>
  <li><code class="highlighter-rouge">train_test_split</code>: the rate of test images to withhold</li>
  <li><code class="highlighter-rouge">shuffle_split</code>: should the images be shuffled in the process</li>
  <li><code class="highlighter-rouge">part_numbers</code>: a list of all the class folders contained in the input</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#####################
# Parameters
#####################     
</span>
<span class="n">dry_run</span>                 <span class="o">=</span> <span class="bp">False</span> <span class="c1"># If true, will print output directory.
</span><span class="n">gray_scale</span>              <span class="o">=</span> <span class="bp">True</span>

<span class="n">root_path</span>               <span class="o">=</span> <span class="s">'./data/'</span>
<span class="n">input_path</span>              <span class="o">=</span> <span class="n">f</span><span class="s">'{root_path}raw/size_1080/'</span>
<span class="n">output_path</span>             <span class="o">=</span> <span class="n">f</span><span class="s">'{root_path}cropped/'</span>

<span class="n">show_image</span>              <span class="o">=</span> <span class="bp">False</span>

<span class="n">output_img_size</span>         <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
<span class="n">grab_area</span>               <span class="o">=</span> <span class="mi">500</span>
<span class="n">train_test_split</span>        <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">shuffle_split</span>           <span class="o">=</span> <span class="bp">True</span>

<span class="n">part_numbers</span>            <span class="o">=</span> <span class="p">[</span>
                           <span class="s">'2456'</span><span class="p">,</span>
                           <span class="s">'3001'</span><span class="p">,</span>
                           <span class="s">'3002'</span><span class="p">,</span>
                           <span class="s">'3003'</span><span class="p">,</span>
                           <span class="s">'3004'</span><span class="p">,</span>
                           <span class="s">'3010'</span><span class="p">,</span>
                           <span class="s">'3039'</span><span class="p">,</span>
                           <span class="s">'3660'</span><span class="p">,</span>
                           <span class="s">'3701'</span><span class="p">,</span>
                           <span class="s">'32064'</span>
                        <span class="p">]</span>
</code></pre></div></div>
<p>Start of the loop.  It is going to loop over every file it finds in the first input class folder, crop it, then save the result.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">part_number</span> <span class="ow">in</span> <span class="n">part_numbers</span><span class="p">:</span>

    <span class="n">part_input_path</span>  <span class="o">=</span> <span class="n">f</span><span class="s">'{input_path}{part_number}/'</span>
    
    <span class="c1"># Get input file paths.
</span>    <span class="n">image_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">f</span><span class="s">'{part_input_path}*.jpg'</span><span class="p">)</span>
    <span class="n">num_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span>

    <span class="c1"># Image index.
</span>    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># If true, the images will be loaded and then split at random.
</span>    <span class="k">if</span> <span class="n">shuffle_split</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_files</span><span class="p">),</span> <span class="n">num_files</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_files</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">file_num</span> <span class="ow">in</span> <span class="n">file_index</span><span class="p">:</span>
        
        <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">input_file_path</span> <span class="o">=</span> <span class="n">f</span><span class="s">'{input_path}{part_number}/{str(file_num).zfill(4)}.jpg'</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'LOADED: {input_file_path}'</span><span class="p">)</span>
        <span class="c1"># Crop raw image from center.
</span>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">input_file_path</span><span class="p">)</span>

        <span class="n">c_x</span><span class="p">,</span> <span class="n">c_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">c_y</span> <span class="o">-</span> <span class="n">grab_area</span><span class="p">:</span> <span class="n">c_y</span> <span class="o">+</span> <span class="n">grab_area</span><span class="p">,</span> <span class="n">c_x</span> <span class="o">-</span> <span class="n">grab_area</span><span class="p">:</span> <span class="n">c_x</span> <span class="o">+</span> <span class="n">grab_area</span><span class="p">]</span>
         
        <span class="c1"># Resize image
</span>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">output_img_size</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">gray_scale</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        
        <span class="c1"># Show to user.
</span>        <span class="k">if</span> <span class="n">show_image</span><span class="p">:</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s">'image'</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span> 

        <span class="c1"># Determine if it should be output to train or test.
</span>        <span class="n">test_or_train</span> <span class="o">=</span> <span class="s">'train'</span>        
        <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_files</span> <span class="o">*</span> <span class="n">train_test_split</span><span class="p">):</span> 
            <span class="n">test_or_train</span> <span class="o">=</span> <span class="s">'test'</span>
        
        <span class="c1"># Prepare the output folder.
</span>        <span class="n">color</span> <span class="o">=</span> <span class="s">''</span>
        <span class="k">if</span> <span class="n">gray_scale</span><span class="p">:</span>
            <span class="n">part_output_folder</span> <span class="o">=</span> <span class="n">f</span><span class="s">'{output_path}gray_scale/{test_or_train}/{part_number}/'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">part_output_folder</span> <span class="o">=</span> <span class="n">f</span><span class="s">'{output_path}color/{test_or_train}/{part_number}/'</span>
            
        <span class="c1"># Make the output directory, if it doesn't exist.
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">part_output_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">part_output_folder</span><span class="p">)</span>

        <span class="c1"># Create part path.
</span>        <span class="n">part_image_path</span> <span class="o">=</span> <span class="n">f</span><span class="s">'{part_output_folder}{part_number}_{index}.jpg'</span>
        
        <span class="c1"># Output
</span>        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'Would have saved to: {part_image_path}'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'SAVED: {part_image_path}'</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">part_image_path</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="classifier-code">Classifier Code:</h2>

<p>Full code may be found here:</p>
<ul>
  <li><a href="https://github.com/Ladvien/lego_sorter/blob/master/lego_classifier_gpu.py">CNN LEGO Trainer (Python)</a></li>
</ul>

<h3 id="classifier-code-needed-libraries">Classifier Code: Needed Libraries</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>


<span class="c1"># Import needed tools.
</span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># Import Keras
</span><span class="kn">import</span> <span class="nn">tensorflow.keras</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dense</span><span class="p">,</span><span class="n">Flatten</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Lambda</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">SeparableConv2D</span><span class="p">,</span> <span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">Activation</span>
<span class="kn">from</span> <span class="nn">tensorflow.compat.v1.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">TensorBoard</span><span class="p">,</span> <span class="n">CSVLogger</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>

<span class="c1"># Tensorboard
</span><span class="kn">from</span> <span class="nn">tensorboard</span> <span class="kn">import</span> <span class="n">program</span>
<span class="kn">import</span> <span class="nn">webbrowser</span>
<span class="kn">import</span> <span class="nn">time</span>
</code></pre></div></div>

<h3 id="classifier-code-parameters">Classifier Code: Parameters</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">continue_training</span>       <span class="o">=</span> <span class="bp">False</span>
<span class="n">initial_epoch</span>           <span class="o">=</span> <span class="mi">0</span>
<span class="n">clear_logs</span>              <span class="o">=</span> <span class="bp">True</span>

<span class="n">input_shape</span>             <span class="o">=</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># This is the shape of the image width, length, colors
</span><span class="n">image_size</span>              <span class="o">=</span> <span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># DOH! image_size is (height, width)
</span><span class="n">train_test_ratio</span>        <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">zoom_range</span>              <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">shear_range</span>             <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># Hyperparameters
</span><span class="n">batch_size</span>              <span class="o">=</span> <span class="mi">16</span>
<span class="n">epochs</span>                  <span class="o">=</span> <span class="mi">40</span>
<span class="n">steps_per_epoch</span>         <span class="o">=</span> <span class="mi">400</span>
<span class="n">validation_steps</span>        <span class="o">=</span> <span class="mi">100</span> 
<span class="n">optimizer</span>               <span class="o">=</span> <span class="s">'adadelta'</span> 
<span class="n">learning_rate</span>           <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">val_save_step_num</span>       <span class="o">=</span> <span class="mi">1</span>

<span class="n">path_to_graphs</span>          <span class="o">=</span> <span class="s">'./data/output/logs/'</span>
<span class="n">model_save_dir</span>          <span class="o">=</span> <span class="s">'./data/output/'</span>
<span class="n">train_dir</span>               <span class="o">=</span> <span class="s">'./lego_id_training_data/gray_train/'</span>
<span class="n">val_dir</span>                 <span class="o">=</span> <span class="s">'./lego_id_training_data/gray_test/'</span>
</code></pre></div></div>

<h3 id="classifier-code-helper-functions">Classifier Code: Helper Functions</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">clear_logs</span><span class="p">:</span>
  <span class="err">!</span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="n">data</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">logs</span><span class="o">/*</span>

<span class="k">def</span> <span class="nf">make_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    

<span class="k">def</span> <span class="nf">show_final_history</span><span class="p">(</span><span class="n">history</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'loss'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Train loss'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation loss'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">'acc'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'acc'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Train acc'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_acc'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation acc'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="classifier-code-data-preparation">Classifier Code: Data Preparation</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#################################
# Create needed dirs
#################################
</span><span class="n">make_dir</span><span class="p">(</span><span class="n">model_save_dir</span><span class="p">)</span>

<span class="c1">#################################
# Data generators
#################################
</span>
<span class="c1"># These Keras generators will pull files from disk
# and prepare them for training and validation.
</span><span class="n">augs_gen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span> <span class="p">(</span>
    <span class="n">shear_range</span> <span class="o">=</span> <span class="n">shear_range</span><span class="p">,</span>  
    <span class="n">zoom_range</span> <span class="o">=</span> <span class="n">shear_range</span><span class="p">,</span>        
    <span class="n">horizontal_flip</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">validation_split</span> <span class="o">=</span> <span class="n">train_test_ratio</span>
<span class="p">)</span>  

<span class="n">train_gen</span> <span class="o">=</span> <span class="n">augs_gen</span><span class="o">.</span><span class="n">flow_from_directory</span> <span class="p">(</span>
    <span class="n">train_dir</span><span class="p">,</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="n">image_size</span><span class="p">,</span> <span class="c1"># THIS IS HEIGHT, WIDTH
</span>    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
    <span class="n">class_mode</span> <span class="o">=</span> <span class="s">'sparse'</span><span class="p">,</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="bp">True</span>
<span class="p">)</span>

<span class="n">test_gen</span> <span class="o">=</span> <span class="n">augs_gen</span><span class="o">.</span><span class="n">flow_from_directory</span> <span class="p">(</span>
    <span class="n">val_dir</span><span class="p">,</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="n">image_size</span><span class="p">,</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span><span class="p">,</span>
    <span class="n">class_mode</span> <span class="o">=</span> <span class="s">'sparse'</span><span class="p">,</span>
    <span class="n">shuffle</span> <span class="o">=</span> <span class="bp">False</span>
<span class="p">)</span>

<span class="c1">#################################
# Save Class IDs
#################################
</span><span class="n">classes_json</span> <span class="o">=</span> <span class="n">train_gen</span><span class="o">.</span><span class="n">class_indices</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_gen</span><span class="o">.</span><span class="n">class_indices</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="classifier-code-building-the-model">Classifier Code: Building the Model</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">())</span>  <span class="c1"># this converts our 3D feature maps to 1D feature vectors
</span>    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span>
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s">'relu'</span><span class="p">))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
    
    <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span> <span class="o">=</span> <span class="s">'softmax'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="c1">#################################
# Create model
#################################
</span>
<span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s">'adam'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">beta_1</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span> <span class="n">beta_2</span> <span class="o">=</span> <span class="mf">0.999</span><span class="p">,</span> <span class="n">epsilon</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">decay</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">amsgrad</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s">'sgd'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span> <span class="o">=</span> <span class="n">learning_rate</span><span class="p">,</span> <span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">optimizer</span> <span class="o">==</span> <span class="s">'adadelta'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tensorflow</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adadelta</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

<span class="n">selected_optimizer</span> <span class="o">=</span> <span class="n">get_optimizer</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">(</span><span class="n">selected_optimizer</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="s">'sparse_categorical_crossentropy'</span><span class="p">,</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">selected_optimizer</span><span class="p">,</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div></div>

<h3 id="classifier-code-creating-callbacks">Classifier Code: Creating Callbacks</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">best_model_weights</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s">'base.model'</span>

<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span>
    <span class="n">best_model_weights</span><span class="p">,</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="s">'val_loss'</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">save_best_only</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s">'min'</span><span class="p">,</span>
    <span class="n">save_weights_only</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="n">period</span> <span class="o">=</span> <span class="n">val_save_step_num</span>
<span class="p">)</span>

<span class="n">earlystop</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span>
    <span class="n">min_delta</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span>
<span class="p">)</span>

<span class="n">tensorboard</span> <span class="o">=</span> <span class="n">TensorBoard</span><span class="p">(</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s">'/logs'</span><span class="p">,</span>
    <span class="n">histogram_freq</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">write_graph</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">write_grads</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">write_images</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">csvlogger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">model_save_dir</span> <span class="o">+</span> <span class="s">'training.csv'</span><span class="p">,</span>
    <span class="n">separator</span> <span class="o">=</span> <span class="s">','</span><span class="p">,</span>
    <span class="n">append</span> <span class="o">=</span> <span class="bp">False</span>
<span class="p">)</span>

<span class="nb">reduce</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span>
    <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span>
    <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span><span class="p">,</span>
    <span class="n">cooldown</span><span class="o">=</span><span class="mi">1</span> 
<span class="p">)</span>

<span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">csvlogger</span><span class="p">,</span> <span class="n">tensorboard</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="classifier-code-training">Classifier Code: Training</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">continue_training</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">best_model_weights</span><span class="p">)</span>
    <span class="n">model_score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate_generator</span><span class="p">(</span><span class="n">test_gen</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">validation_steps</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Model Test Loss:'</span><span class="p">,</span> <span class="n">model_score</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Model Test Accuracy:'</span><span class="p">,</span> <span class="n">model_score</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>


<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span>
    <span class="n">train_gen</span><span class="p">,</span> 
    <span class="n">steps_per_epoch</span>  <span class="o">=</span> <span class="n">steps_per_epoch</span><span class="p">,</span> 
    <span class="n">validation_data</span>  <span class="o">=</span> <span class="n">test_gen</span><span class="p">,</span>
    <span class="n">validation_steps</span> <span class="o">=</span> <span class="n">validation_steps</span><span class="p">,</span>
    <span class="n">epochs</span> <span class="o">=</span> <span class="n">epochs</span><span class="p">,</span> 
    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="n">callbacks</span>
<span class="p">)</span>
</code></pre></div></div>
:ET