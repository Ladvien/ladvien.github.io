---
layout: post
title: Bluetooth LE in JavaScript
categories: robots
excerpt:
tags: [robots]
image:
comments: true
custom_css: js-ble
custom_js: 
- terminal  
- lumi-comm-ble
- js-ble
---

# From Metal to JavaScript

I've never programmed anything in JavaScript.  For the most part, I stay away from web development like herpes.  However, I've recently been under pressure from my day job.  It has lead top eyeing positions in the developer world, and sadly, if one doesn't know how to do simple webdevelopment, there doesn't seem to be much need for their skills.

With that, I'm taking several courses from Udemy:

1. The Complete JavaScript Course
2. JavaScript: The Weird Parts
3. The Web Developer Bootcamp

All seem to be worth the $10 I've spent.  However, I was struggling trying to find a project that'd interest me enough to practice.  That's when I discovered Google's Web API which has a framwork which allows for interaction with Bluetooth LE devices from inside the browser!  Now I've got some projects.  

Below is a sample of the project.  Currently, it is merely a BLE serial terminal--but I'll attempt to develop it into a TinySafeBootloader, like my C# projects.

{% include lumi-communication-js.html %}


## js-ble.js ## 

This is the main app.js
{% highlight javascript %}

//https://developer.mozilla.org/en-US/docs/Web/API/BluetoothRemoteGATTServer
var log = console.log;
//var writeCharacteristic;
var descriptor;
var receivedString = "";
var terminalLineCounter = 0;
var displayDOM = 'terminal';

let primaryService = document.getElementById('optionalServices').value;

var terminal = new Terminal(displayDOM);

function onScanButtonClick() {
    lumiBle.searchAndConnect(0xFFE0).
    then(() => {
        lumiBle.addReceivedDataCallback(onReceivedData)     
    })
}

function onReceivedData(event){
    for(var i = 0; i < event.target.value.byteLength; i ++){
        receivedString += String.fromCharCode(event.target.value.getUint8(i));
    }
    terminal.addTerminalLine(displayDOM, receivedString, '<- ', 'received-text');
    receivedString = "";
}

function onWriteButtonClick(){
    let textToWrite = document.getElementById('textToWrite').value;
//        writeCharacteristic.writeValue(encoder.encode(textToWrite))
    lumiBle.writeData(textToWrite)
    .then(_ => {
        terminal.addTerminalLine(displayDOM, textToWrite, '-> ', 'sent-text');
    })
}

/* Utils */
function getSupportedProperties(characteristic) {
  let supportedProperties = [];
  for (const p in characteristic.properties) {
    if (characteristic.properties[p] === true) {
      supportedProperties.push(p.toUpperCase());
    }
  }
  return '[' + supportedProperties.join(', ') + ']';
}

document.getElementById('btn-1').onclick = onScanButtonClick;
document.getElementById('btn-write-ble').onclick = onWriteButtonClick;

var lumiBle = new LumiBluetooth();
{% endhighlight %}



